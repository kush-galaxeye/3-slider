{"ast":null,"code":"import { timestamp, log, warn } from \"../utils.js\";\nimport { Timestamp } from \"../messages/index.js\";\nimport Nodes from \"./nodes.js\";\nimport Observer from \"./observer/top_observer.js\";\nimport Ticker from \"./ticker.js\";\nimport { deviceMemory, jsHeapSizeLimit } from \"../modules/performance.js\"; // TODO: use backendHost only\n\nexport const DEFAULT_INGEST_POINT = 'https://api.openreplay.com/ingest';\nexport default class App {\n  constructor(projectKey, sessionToken, opts) {\n    this.messages = [];\n    this.startCallbacks = [];\n    this.stopCallbacks = [];\n    this.commitCallbacks = [];\n    this._sessionID = null;\n    this.isActive = false;\n    this.version = '3.4.16';\n    this.projectKey = projectKey;\n    this.options = Object.assign({\n      revID: '',\n      node_id: '__openreplay_id',\n      session_token_key: '__openreplay_token',\n      session_pageno_key: '__openreplay_pageno',\n      local_uuid_key: '__openreplay_uuid',\n      ingestPoint: DEFAULT_INGEST_POINT,\n      resourceBaseHref: null,\n      __is_snippet: false,\n      __debug_report_edp: null,\n      __debug_log: false,\n      obscureTextEmails: true,\n      obscureTextNumbers: false,\n      captureIFrames: false\n    }, opts);\n\n    if (sessionToken != null) {\n      sessionStorage.setItem(this.options.session_token_key, sessionToken);\n    }\n\n    this.revID = this.options.revID;\n    this.nodes = new Nodes(this.options.node_id);\n    this.observer = new Observer(this, this.options);\n    this.ticker = new Ticker(this);\n    this.ticker.attach(() => this.commit());\n\n    try {\n      this.worker = new Worker(URL.createObjectURL(new Blob([`\"use strict\";function t(t){function s(...s){return new t(...s)}return s.prototype=t.prototype,s}const s=new Map;const i=t(class{constructor(t,s,i){this.pageNo=t,this.firstIndex=s,this.timestamp=i,this._id=80}encode(t){return t.uint(80)&&t.uint(this.pageNo)&&t.uint(this.firstIndex)&&t.int(this.timestamp)}});s.set(80,i);const n=t(class{constructor(t){this.timestamp=t,this._id=0}encode(t){return t.uint(0)&&t.uint(this.timestamp)}});s.set(0,n);const e=t(class{constructor(t,s,i){this.url=t,this.referrer=s,this.navigationStart=i,this._id=4}encode(t){return t.uint(4)&&t.string(this.url)&&t.string(this.referrer)&&t.uint(this.navigationStart)}});s.set(4,e);const r=t(class{constructor(t,s){this.width=t,this.height=s,this._id=5}encode(t){return t.uint(5)&&t.uint(this.width)&&t.uint(this.height)}});s.set(5,r);const o=t(class{constructor(t,s){this.x=t,this.y=s,this._id=6}encode(t){return t.uint(6)&&t.int(this.x)&&t.int(this.y)}});s.set(6,o);const h=t(class{constructor(){this._id=7}encode(t){return t.uint(7)}});s.set(7,h);const c=t(class{constructor(t,s,i,n,e){this.id=t,this.parentID=s,this.index=i,this.tag=n,this.svg=e,this._id=8}encode(t){return t.uint(8)&&t.uint(this.id)&&t.uint(this.parentID)&&t.uint(this.index)&&t.string(this.tag)&&t.boolean(this.svg)}});s.set(8,c);const u=t(class{constructor(t,s,i){this.id=t,this.parentID=s,this.index=i,this._id=9}encode(t){return t.uint(9)&&t.uint(this.id)&&t.uint(this.parentID)&&t.uint(this.index)}});s.set(9,u);const a=t(class{constructor(t,s,i){this.id=t,this.parentID=s,this.index=i,this._id=10}encode(t){return t.uint(10)&&t.uint(this.id)&&t.uint(this.parentID)&&t.uint(this.index)}});s.set(10,a);const d=t(class{constructor(t){this.id=t,this._id=11}encode(t){return t.uint(11)&&t.uint(this.id)}});s.set(11,d);const l=t(class{constructor(t,s,i){this.id=t,this.name=s,this.value=i,this._id=12}encode(t){return t.uint(12)&&t.uint(this.id)&&t.string(this.name)&&t.string(this.value)}});s.set(12,l);const g=t(class{constructor(t,s){this.id=t,this.name=s,this._id=13}encode(t){return t.uint(13)&&t.uint(this.id)&&t.string(this.name)}});s.set(13,g);const f=t(class{constructor(t,s){this.id=t,this.data=s,this._id=14}encode(t){return t.uint(14)&&t.uint(this.id)&&t.string(this.data)}});s.set(14,f);const p=t(class{constructor(t,s,i){this.id=t,this.x=s,this.y=i,this._id=16}encode(t){return t.uint(16)&&t.uint(this.id)&&t.int(this.x)&&t.int(this.y)}});s.set(16,p);const m=t(class{constructor(t,s){this.id=t,this.label=s,this._id=17}encode(t){return t.uint(17)&&t.uint(this.id)&&t.string(this.label)}});s.set(17,m);const _=t(class{constructor(t,s,i){this.id=t,this.value=s,this.mask=i,this._id=18}encode(t){return t.uint(18)&&t.uint(this.id)&&t.string(this.value)&&t.int(this.mask)}});s.set(18,_);const y=t(class{constructor(t,s){this.id=t,this.checked=s,this._id=19}encode(t){return t.uint(19)&&t.uint(this.id)&&t.boolean(this.checked)}});s.set(19,y);const v=t(class{constructor(t,s){this.x=t,this.y=s,this._id=20}encode(t){return t.uint(20)&&t.uint(this.x)&&t.uint(this.y)}});s.set(20,v);const S=t(class{constructor(t,s){this.level=t,this.value=s,this._id=22}encode(t){return t.uint(22)&&t.string(this.level)&&t.string(this.value)}});s.set(22,S);const b=t(class{constructor(t,s,i,n,e,r,o,h,c){this.requestStart=t,this.responseStart=s,this.responseEnd=i,this.domContentLoadedEventStart=n,this.domContentLoadedEventEnd=e,this.loadEventStart=r,this.loadEventEnd=o,this.firstPaint=h,this.firstContentfulPaint=c,this._id=23}encode(t){return t.uint(23)&&t.uint(this.requestStart)&&t.uint(this.responseStart)&&t.uint(this.responseEnd)&&t.uint(this.domContentLoadedEventStart)&&t.uint(this.domContentLoadedEventEnd)&&t.uint(this.loadEventStart)&&t.uint(this.loadEventEnd)&&t.uint(this.firstPaint)&&t.uint(this.firstContentfulPaint)}});s.set(23,b);const x=t(class{constructor(t,s,i){this.speedIndex=t,this.visuallyComplete=s,this.timeToInteractive=i,this._id=24}encode(t){return t.uint(24)&&t.uint(this.speedIndex)&&t.uint(this.visuallyComplete)&&t.uint(this.timeToInteractive)}});s.set(24,x);const E=t(class{constructor(t,s,i){this.name=t,this.message=s,this.payload=i,this._id=25}encode(t){return t.uint(25)&&t.string(this.name)&&t.string(this.message)&&t.string(this.payload)}});s.set(25,E);const k=t(class{constructor(t,s){this.name=t,this.payload=s,this._id=27}encode(t){return t.uint(27)&&t.string(this.name)&&t.string(this.payload)}});s.set(27,k);const I=t(class{constructor(t){this.id=t,this._id=28}encode(t){return t.uint(28)&&t.string(this.id)}});s.set(28,I);const z=t(class{constructor(t){this.id=t,this._id=29}encode(t){return t.uint(29)&&t.string(this.id)}});s.set(29,z);const w=t(class{constructor(t,s){this.key=t,this.value=s,this._id=30}encode(t){return t.uint(30)&&t.string(this.key)&&t.string(this.value)}});s.set(30,w);const T=t(class{constructor(t,s,i){this.id=t,this.rule=s,this.index=i,this._id=37}encode(t){return t.uint(37)&&t.uint(this.id)&&t.string(this.rule)&&t.uint(this.index)}});s.set(37,T);const L=t(class{constructor(t,s){this.id=t,this.index=s,this._id=38}encode(t){return t.uint(38)&&t.uint(this.id)&&t.uint(this.index)}});s.set(38,L);const A=t(class{constructor(t,s,i,n,e,r,o){this.method=t,this.url=s,this.request=i,this.response=n,this.status=e,this.timestamp=r,this.duration=o,this._id=39}encode(t){return t.uint(39)&&t.string(this.method)&&t.string(this.url)&&t.string(this.request)&&t.string(this.response)&&t.uint(this.status)&&t.uint(this.timestamp)&&t.uint(this.duration)}});s.set(39,A);const C=t(class{constructor(t,s,i,n){this.name=t,this.duration=s,this.args=i,this.result=n,this._id=40}encode(t){return t.uint(40)&&t.string(this.name)&&t.uint(this.duration)&&t.string(this.args)&&t.string(this.result)}});s.set(40,C);const M=t(class{constructor(t,s){this.key=t,this.value=s,this._id=41}encode(t){return t.uint(41)&&t.string(this.key)&&t.string(this.value)}});s.set(41,M);const R=t(class{constructor(t){this.type=t,this._id=42}encode(t){return t.uint(42)&&t.string(this.type)}});s.set(42,R);const N=t(class{constructor(t,s,i){this.action=t,this.state=s,this.duration=i,this._id=44}encode(t){return t.uint(44)&&t.string(this.action)&&t.string(this.state)&&t.uint(this.duration)}});s.set(44,N);const D=t(class{constructor(t,s){this.mutation=t,this.state=s,this._id=45}encode(t){return t.uint(45)&&t.string(this.mutation)&&t.string(this.state)}});s.set(45,D);const U=t(class{constructor(t,s){this.type=t,this.payload=s,this._id=46}encode(t){return t.uint(46)&&t.string(this.type)&&t.string(this.payload)}});s.set(46,U);const O=t(class{constructor(t,s,i){this.action=t,this.state=s,this.duration=i,this._id=47}encode(t){return t.uint(47)&&t.string(this.action)&&t.string(this.state)&&t.uint(this.duration)}});s.set(47,O);const q=t(class{constructor(t,s,i,n){this.operationKind=t,this.operationName=s,this.variables=i,this.response=n,this._id=48}encode(t){return t.uint(48)&&t.string(this.operationKind)&&t.string(this.operationName)&&t.string(this.variables)&&t.string(this.response)}});s.set(48,q);const H=t(class{constructor(t,s,i,n){this.frames=t,this.ticks=s,this.totalJSHeapSize=i,this.usedJSHeapSize=n,this._id=49}encode(t){return t.uint(49)&&t.int(this.frames)&&t.int(this.ticks)&&t.uint(this.totalJSHeapSize)&&t.uint(this.usedJSHeapSize)}});s.set(49,H);const P=t(class{constructor(t,s,i,n,e,r,o,h){this.timestamp=t,this.duration=s,this.ttfb=i,this.headerSize=n,this.encodedBodySize=e,this.decodedBodySize=r,this.url=o,this.initiator=h,this._id=53}encode(t){return t.uint(53)&&t.uint(this.timestamp)&&t.uint(this.duration)&&t.uint(this.ttfb)&&t.uint(this.headerSize)&&t.uint(this.encodedBodySize)&&t.uint(this.decodedBodySize)&&t.string(this.url)&&t.string(this.initiator)}});s.set(53,P);const B=t(class{constructor(t,s){this.downlink=t,this.type=s,this._id=54}encode(t){return t.uint(54)&&t.uint(this.downlink)&&t.string(this.type)}});s.set(54,B);const J=t(class{constructor(t){this.hidden=t,this._id=55}encode(t){return t.uint(55)&&t.boolean(this.hidden)}});s.set(55,J);const j=t(class{constructor(t,s,i,n,e,r,o){this.timestamp=t,this.duration=s,this.context=i,this.containerType=n,this.containerSrc=e,this.containerId=r,this.containerName=o,this._id=59}encode(t){return t.uint(59)&&t.uint(this.timestamp)&&t.uint(this.duration)&&t.uint(this.context)&&t.uint(this.containerType)&&t.string(this.containerSrc)&&t.string(this.containerId)&&t.string(this.containerName)}});s.set(59,j);const G=t(class{constructor(t,s,i,n){this.id=t,this.name=s,this.value=i,this.baseURL=n,this._id=60}encode(t){return t.uint(60)&&t.uint(this.id)&&t.string(this.name)&&t.string(this.value)&&t.string(this.baseURL)}});s.set(60,G);const K=t(class{constructor(t,s,i){this.id=t,this.data=s,this.baseURL=i,this._id=61}encode(t){return t.uint(61)&&t.uint(this.id)&&t.string(this.data)&&t.string(this.baseURL)}});s.set(61,K);const X=t(class{constructor(t,s){this.type=t,this.value=s,this._id=63}encode(t){return t.uint(63)&&t.string(this.type)&&t.string(this.value)}});s.set(63,X);const F=t(class{constructor(t,s){this.name=t,this.payload=s,this._id=64}encode(t){return t.uint(64)&&t.string(this.name)&&t.string(this.payload)}});s.set(64,F);const Q=t(class{constructor(){this._id=65}encode(t){return t.uint(65)}});s.set(65,Q);const V=t(class{constructor(t,s,i,n){this.id=t,this.rule=s,this.index=i,this.baseURL=n,this._id=67}encode(t){return t.uint(67)&&t.uint(this.id)&&t.string(this.rule)&&t.uint(this.index)&&t.string(this.baseURL)}});s.set(67,V);const W=t(class{constructor(t,s,i,n){this.id=t,this.hesitationTime=s,this.label=i,this.selector=n,this._id=69}encode(t){return t.uint(69)&&t.uint(this.id)&&t.uint(this.hesitationTime)&&t.string(this.label)&&t.string(this.selector)}});s.set(69,W);const Y=t(class{constructor(t,s){this.frameID=t,this.id=s,this._id=70}encode(t){return t.uint(70)&&t.uint(this.frameID)&&t.uint(this.id)}});s.set(70,Y);const Z=\"function\"==typeof TextEncoder?new TextEncoder:{encode(t){const s=t.length,i=new Uint8Array(3*s);let n=-1;for(var e=0,r=0,o=0;o!==s;){if(e=t.charCodeAt(o),o+=1,e>=55296&&e<=56319){if(o===s){i[n+=1]=239,i[n+=1]=191,i[n+=1]=189;break}if(!((r=t.charCodeAt(o))>=56320&&r<=57343)){i[n+=1]=239,i[n+=1]=191,i[n+=1]=189;continue}if(o+=1,(e=1024*(e-55296)+r-56320+65536)>65535){i[n+=1]=240|e>>>18,i[n+=1]=128|e>>>12&63,i[n+=1]=128|e>>>6&63,i[n+=1]=128|63&e;continue}}e<=127?i[n+=1]=0|e:e<=2047?(i[n+=1]=192|e>>>6,i[n+=1]=128|63&e):(i[n+=1]=224|e>>>12,i[n+=1]=128|e>>>6&63,i[n+=1]=128|63&e)}return i.subarray(0,n+1)}};class tt{constructor(t){this.size=t,this.offset=0,this.checkpointOffset=0,this.data=new Uint8Array(t)}checkpoint(){this.checkpointOffset=this.offset}isEmpty(){return 0===this.offset}boolean(t){return this.data[this.offset++]=+t,this.offset<=this.size}uint(t){for((t<0||t>Number.MAX_SAFE_INTEGER)&&(t=0);t>=128;)this.data[this.offset++]=t%256|128,t=Math.floor(t/128);return this.data[this.offset++]=t,this.offset<=this.size}int(t){return t=Math.round(t),this.uint(t>=0?2*t:-2*t-1)}string(t){const s=Z.encode(t),i=s.byteLength;return!(!this.uint(i)||this.offset+i>this.size)&&(this.data.set(s,this.offset),this.offset+=i,!0)}reset(){this.offset=0,this.checkpointOffset=0}flush(){const t=this.data.slice(0,this.checkpointOffset);return this.reset(),t}}let st=1e6,it=2e5,nt=new tt(it),et=\"\",rt=\"\",ot=0,ht=0,ct=0,ut=0,at=!0;function dt(){return new i(ot,ut,ht).encode(nt)}let lt=null;const gt=[];let ft,pt=!1,mt=0,_t=8e3,yt=10;function vt(){if(at||\"\"===rt||\"\"===et)return;const t=nt.flush();pt?gt.push(t):(pt=!0,function t(s){const i=new XMLHttpRequest;i.open(\"POST\",et+\"/v1/web/i\",!1),i.setRequestHeader(\"Authorization\",\"Bearer \"+rt),i.onreadystatechange=function(){if(4===this.readyState){if(0==this.status)return;if(this.status>=400)return St(),gt.length=0,401===this.status?void self.postMessage(\"restart\"):void self.postMessage(null);const s=gt.shift();s?t(s):pt=!1}},i.onerror=function(i){if(mt>=yt)return St(),void self.postMessage(null);mt++,setTimeout(()=>t(s),_t)},i.send(s.buffer)}(t)),at=!0,dt()}function St(){et=\"\",rt=\"\",null!==lt&&(clearInterval(lt),lt=null),nt.reset()}self.onmessage=({data:t})=>{if(null!==t)return\"stop\"===t?(vt(),void St()):Array.isArray(t)?void t.forEach(t=>{const i=new(s.get(t._id));if(Object.assign(i,t),i instanceof n?ht=i.timestamp:i instanceof J&&(i.hidden?ft=setTimeout(()=>self.postMessage(\"restart\"),18e5):clearTimeout(ft)),nt.checkpoint(),!i.encode(nt)&&(vt(),!i.encode(nt)))for(;!i.encode(nt);){if(it===st)return console.warn(\"OpenReplay: beacon size overflow.\"),nt.reset(),void dt();it=Math.min(2*it,st),nt=new tt(it),dt()}ut++,at=!1}):(et=t.ingestPoint||et,rt=t.token||rt,ot=t.pageNo||ot,ht=t.startTimestamp||ht,ct=t.timeAdjustment||ct,yt=t.connAttemptCount||yt,_t=t.connAttemptGap||_t,st=t.beaconSizeLimit||st,it=Math.min(st,t.beaconSize||it),nt.isEmpty()&&dt(),void(null===lt&&(lt=setInterval(vt,1e4))));vt()};\n`], {\n        type: 'text/javascript'\n      })));\n\n      this.worker.onerror = e => {\n        this._debug(\"webworker_error\", e);\n      };\n\n      let lastTs = timestamp();\n      let fileno = 0;\n\n      this.worker.onmessage = _ref => {\n        let {\n          data\n        } = _ref;\n\n        if (data === null) {\n          this.stop();\n        } else if (data === \"restart\") {\n          this.stop();\n          this.start(true);\n        }\n      };\n\n      const alertWorker = () => {\n        if (this.worker) {\n          this.worker.postMessage(null);\n        }\n      }; // TODO: keep better tactics, discard others (look https://developer.mozilla.org/en-US/docs/Web/API/Navigator/sendBeacon)\n\n\n      this.attachEventListener(window, 'beforeunload', alertWorker, false);\n      this.attachEventListener(document, 'mouseleave', alertWorker, false, false);\n      this.attachEventListener(document, 'visibilitychange', alertWorker, false);\n    } catch (e) {\n      this._debug(\"worker_start\", e);\n    }\n  }\n\n  _debug(context, e) {\n    if (this.options.__debug_report_edp !== null) {\n      fetch(this.options.__debug_report_edp, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify({\n          context,\n          error: `${e}`\n        })\n      });\n    }\n\n    if (this.options.__debug_log) {\n      warn(\"OpenReplay error: \", context, e);\n    }\n  }\n\n  send(message) {\n    let urgent = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;\n\n    if (!this.isActive) {\n      return;\n    }\n\n    this.messages.push(message);\n\n    if (urgent) {\n      this.commit();\n    }\n  }\n\n  commit() {\n    if (this.worker && this.messages.length) {\n      this.messages.unshift(new Timestamp(timestamp()));\n      this.worker.postMessage(this.messages);\n      this.commitCallbacks.forEach(cb => cb(this.messages));\n      this.messages.length = 0;\n    }\n  }\n\n  attachCommitCallback(cb) {\n    this.commitCallbacks.push(cb);\n  } // @Depricated (TODO: remove in 3.5.*)\n\n\n  addCommitCallback(cb) {\n    this.attachCommitCallback(cb);\n  }\n\n  safe(fn) {\n    const app = this;\n    return function () {\n      try {\n        for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {\n          args[_key] = arguments[_key];\n        }\n\n        fn.apply(this, args);\n      } catch (e) {\n        app._debug(\"safe_fn_call\", e); // time: timestamp(),\n        // name: e.name,\n        // message: e.message,\n        // stack: e.stack\n\n      }\n    }; // TODO: correct typing\n  }\n\n  attachStartCallback(cb) {\n    this.startCallbacks.push(cb);\n  }\n\n  attachStopCallback(cb) {\n    this.stopCallbacks.push(cb);\n  }\n\n  attachEventListener(target, type, listener) {\n    let useSafe = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : true;\n    let useCapture = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : true;\n\n    if (useSafe) {\n      listener = this.safe(listener);\n    }\n\n    this.attachStartCallback(() => target.addEventListener(type, listener, useCapture));\n    this.attachStopCallback(() => target.removeEventListener(type, listener, useCapture));\n  }\n\n  getSessionToken() {\n    const token = sessionStorage.getItem(this.options.session_token_key);\n\n    if (token !== null) {\n      return token;\n    }\n  }\n\n  getSessionID() {\n    return this._sessionID || undefined;\n  }\n\n  getHost() {\n    return new URL(this.options.ingestPoint).hostname;\n  }\n\n  getProjectKey() {\n    return this.projectKey;\n  }\n\n  getBaseHref() {\n    var _a, _b;\n\n    if (typeof this.options.resourceBaseHref === 'string') {\n      return this.options.resourceBaseHref;\n    } else if (typeof this.options.resourceBaseHref === 'object') {//switch between  types\n    }\n\n    if (document.baseURI) {\n      return document.baseURI;\n    } // IE only\n\n\n    return ((_b = (_a = document.head) === null || _a === void 0 ? void 0 : _a.getElementsByTagName(\"base\")[0]) === null || _b === void 0 ? void 0 : _b.getAttribute(\"href\")) || location.origin + location.pathname;\n  }\n\n  resolveResourceURL(resourceURL) {\n    const base = new URL(this.getBaseHref());\n    base.pathname += \"/\" + new URL(resourceURL).pathname;\n    base.pathname.replace(/\\/+/g, \"/\");\n    return base.toString();\n  }\n\n  isServiceURL(url) {\n    return url.startsWith(this.options.ingestPoint);\n  }\n\n  active() {\n    return this.isActive;\n  }\n\n  _start(reset) {\n    if (!this.isActive) {\n      if (!this.worker) {\n        return Promise.reject(\"No worker found: perhaps, CSP is not set.\");\n      }\n\n      this.isActive = true;\n      let pageNo = 0;\n      const pageNoStr = sessionStorage.getItem(this.options.session_pageno_key);\n\n      if (pageNoStr != null) {\n        pageNo = parseInt(pageNoStr);\n        pageNo++;\n      }\n\n      sessionStorage.setItem(this.options.session_pageno_key, pageNo.toString());\n      const startTimestamp = timestamp();\n      const messageData = {\n        ingestPoint: this.options.ingestPoint,\n        pageNo,\n        startTimestamp,\n        connAttemptCount: this.options.connAttemptCount,\n        connAttemptGap: this.options.connAttemptGap\n      };\n      this.worker.postMessage(messageData); // brings delay of 10th ms?\n      // let token = sessionStorage.getItem(this.options.session_token_key)\n      // const tokenIsActive = localStorage.getItem(\"__or_at_\" + token)\n      // if (tokenIsActive) {\n      //   token = null\n      // }\n\n      return window.fetch(this.options.ingestPoint + '/v1/web/start', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify({\n          token: sessionStorage.getItem(this.options.session_token_key),\n          userUUID: localStorage.getItem(this.options.local_uuid_key),\n          projectKey: this.projectKey,\n          revID: this.revID,\n          timestamp: startTimestamp,\n          trackerVersion: this.version,\n          isSnippet: this.options.__is_snippet,\n          deviceMemory,\n          jsHeapSizeLimit,\n          reset\n        })\n      }).then(r => {\n        if (r.status === 200) {\n          return r.json();\n        } else {\n          // TODO: handle canceling && 403\n          return r.text().then(text => {\n            throw new Error(`Server error: ${r.status}. ${text}`);\n          });\n        }\n      }).then(r => {\n        const {\n          token,\n          userUUID,\n          sessionID,\n          beaconSizeLimit\n        } = r;\n\n        if (typeof token !== 'string' || typeof userUUID !== 'string' || typeof beaconSizeLimit !== 'number' && typeof beaconSizeLimit !== 'undefined') {\n          throw new Error(`Incorrect server response: ${JSON.stringify(r)}`);\n        }\n\n        sessionStorage.setItem(this.options.session_token_key, token);\n        localStorage.setItem(this.options.local_uuid_key, userUUID); // localStorage.setItem(\"__or_at_\" + token, \"true\")\n        // this.attachEventListener(window, 'beforeunload', ()=>{\n        //   localStorage.removeItem(\"__or_at_\" + token)\n        // }, false);\n        // this.attachEventListener(window, 'pagehide', ()=>{\n        //   localStorage.removeItem(\"__or_at_\" + token)\n        // }, false);\n\n        if (typeof sessionID === 'string') {\n          this._sessionID = sessionID;\n        }\n\n        if (!this.worker) {\n          throw new Error(\"no worker found after start request (this might not happen)\");\n        }\n\n        this.worker.postMessage({\n          token,\n          beaconSizeLimit\n        });\n        this.startCallbacks.forEach(cb => cb());\n        this.observer.observe();\n        this.ticker.start();\n        log(\"OpenReplay tracking started.\");\n        const onStartInfo = {\n          sessionToken: token,\n          userUUID,\n          sessionID\n        };\n\n        if (typeof this.options.onStart === 'function') {\n          this.options.onStart(onStartInfo);\n        }\n\n        return onStartInfo;\n      }).catch(e => {\n        sessionStorage.removeItem(this.options.session_token_key);\n        this.stop();\n        warn(\"OpenReplay was unable to start. \", e);\n\n        this._debug(\"session_start\", e);\n\n        throw e;\n      });\n    }\n\n    return Promise.reject(\"Player is already active\");\n  }\n\n  start() {\n    let reset = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : false;\n\n    if (!document.hidden) {\n      return this._start(reset);\n    } else {\n      return new Promise(resolve => {\n        const onVisibilityChange = () => {\n          if (!document.hidden) {\n            document.removeEventListener(\"visibilitychange\", onVisibilityChange);\n            resolve(this._start(reset));\n          }\n        };\n\n        document.addEventListener(\"visibilitychange\", onVisibilityChange);\n      });\n    }\n  }\n\n  stop() {\n    if (this.isActive) {\n      try {\n        if (this.worker) {\n          this.worker.postMessage(\"stop\");\n        }\n\n        this.observer.disconnect();\n        this.nodes.clear();\n        this.ticker.stop();\n        this.stopCallbacks.forEach(cb => cb());\n        log(\"OpenReplay tracking stopped.\");\n      } finally {\n        this.isActive = false;\n      }\n    }\n  }\n\n}","map":{"version":3,"sources":["/Users/kushthakker/Downloads/imagecompare-both/node_modules/@openreplay/tracker/lib/app/index.js"],"names":["timestamp","log","warn","Timestamp","Nodes","Observer","Ticker","deviceMemory","jsHeapSizeLimit","DEFAULT_INGEST_POINT","App","constructor","projectKey","sessionToken","opts","messages","startCallbacks","stopCallbacks","commitCallbacks","_sessionID","isActive","version","options","Object","assign","revID","node_id","session_token_key","session_pageno_key","local_uuid_key","ingestPoint","resourceBaseHref","__is_snippet","__debug_report_edp","__debug_log","obscureTextEmails","obscureTextNumbers","captureIFrames","sessionStorage","setItem","nodes","observer","ticker","attach","commit","worker","Worker","URL","createObjectURL","Blob","type","onerror","e","_debug","lastTs","fileno","onmessage","data","stop","start","alertWorker","postMessage","attachEventListener","window","document","context","fetch","method","headers","body","JSON","stringify","error","send","message","urgent","push","length","unshift","forEach","cb","attachCommitCallback","addCommitCallback","safe","fn","app","args","apply","attachStartCallback","attachStopCallback","target","listener","useSafe","useCapture","addEventListener","removeEventListener","getSessionToken","token","getItem","getSessionID","undefined","getHost","hostname","getProjectKey","getBaseHref","_a","_b","baseURI","head","getElementsByTagName","getAttribute","location","origin","pathname","resolveResourceURL","resourceURL","base","replace","toString","isServiceURL","url","startsWith","active","_start","reset","Promise","reject","pageNo","pageNoStr","parseInt","startTimestamp","messageData","connAttemptCount","connAttemptGap","userUUID","localStorage","trackerVersion","isSnippet","then","r","status","json","text","Error","sessionID","beaconSizeLimit","observe","onStartInfo","onStart","catch","removeItem","hidden","resolve","onVisibilityChange","disconnect","clear"],"mappings":"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","sourcesContent":["import { timestamp, log, warn } from \"../utils.js\";\nimport { Timestamp } from \"../messages/index.js\";\nimport Nodes from \"./nodes.js\";\nimport Observer from \"./observer/top_observer.js\";\nimport Ticker from \"./ticker.js\";\nimport { deviceMemory, jsHeapSizeLimit } from \"../modules/performance.js\";\n// TODO: use backendHost only\nexport const DEFAULT_INGEST_POINT = 'https://api.openreplay.com/ingest';\nexport default class App {\n    constructor(projectKey, sessionToken, opts) {\n        this.messages = [];\n        this.startCallbacks = [];\n        this.stopCallbacks = [];\n        this.commitCallbacks = [];\n        this._sessionID = null;\n        this.isActive = false;\n        this.version = '3.4.16';\n        this.projectKey = projectKey;\n        this.options = Object.assign({\n            revID: '',\n            node_id: '__openreplay_id',\n            session_token_key: '__openreplay_token',\n            session_pageno_key: '__openreplay_pageno',\n            local_uuid_key: '__openreplay_uuid',\n            ingestPoint: DEFAULT_INGEST_POINT,\n            resourceBaseHref: null,\n            __is_snippet: false,\n            __debug_report_edp: null,\n            __debug_log: false,\n            obscureTextEmails: true,\n            obscureTextNumbers: false,\n            captureIFrames: false,\n        }, opts);\n        if (sessionToken != null) {\n            sessionStorage.setItem(this.options.session_token_key, sessionToken);\n        }\n        this.revID = this.options.revID;\n        this.nodes = new Nodes(this.options.node_id);\n        this.observer = new Observer(this, this.options);\n        this.ticker = new Ticker(this);\n        this.ticker.attach(() => this.commit());\n        try {\n            this.worker = new Worker(URL.createObjectURL(new Blob([`\"use strict\";function t(t){function s(...s){return new t(...s)}return s.prototype=t.prototype,s}const s=new Map;const i=t(class{constructor(t,s,i){this.pageNo=t,this.firstIndex=s,this.timestamp=i,this._id=80}encode(t){return t.uint(80)&&t.uint(this.pageNo)&&t.uint(this.firstIndex)&&t.int(this.timestamp)}});s.set(80,i);const n=t(class{constructor(t){this.timestamp=t,this._id=0}encode(t){return t.uint(0)&&t.uint(this.timestamp)}});s.set(0,n);const e=t(class{constructor(t,s,i){this.url=t,this.referrer=s,this.navigationStart=i,this._id=4}encode(t){return t.uint(4)&&t.string(this.url)&&t.string(this.referrer)&&t.uint(this.navigationStart)}});s.set(4,e);const r=t(class{constructor(t,s){this.width=t,this.height=s,this._id=5}encode(t){return t.uint(5)&&t.uint(this.width)&&t.uint(this.height)}});s.set(5,r);const o=t(class{constructor(t,s){this.x=t,this.y=s,this._id=6}encode(t){return t.uint(6)&&t.int(this.x)&&t.int(this.y)}});s.set(6,o);const h=t(class{constructor(){this._id=7}encode(t){return t.uint(7)}});s.set(7,h);const c=t(class{constructor(t,s,i,n,e){this.id=t,this.parentID=s,this.index=i,this.tag=n,this.svg=e,this._id=8}encode(t){return t.uint(8)&&t.uint(this.id)&&t.uint(this.parentID)&&t.uint(this.index)&&t.string(this.tag)&&t.boolean(this.svg)}});s.set(8,c);const u=t(class{constructor(t,s,i){this.id=t,this.parentID=s,this.index=i,this._id=9}encode(t){return t.uint(9)&&t.uint(this.id)&&t.uint(this.parentID)&&t.uint(this.index)}});s.set(9,u);const a=t(class{constructor(t,s,i){this.id=t,this.parentID=s,this.index=i,this._id=10}encode(t){return t.uint(10)&&t.uint(this.id)&&t.uint(this.parentID)&&t.uint(this.index)}});s.set(10,a);const d=t(class{constructor(t){this.id=t,this._id=11}encode(t){return t.uint(11)&&t.uint(this.id)}});s.set(11,d);const l=t(class{constructor(t,s,i){this.id=t,this.name=s,this.value=i,this._id=12}encode(t){return t.uint(12)&&t.uint(this.id)&&t.string(this.name)&&t.string(this.value)}});s.set(12,l);const g=t(class{constructor(t,s){this.id=t,this.name=s,this._id=13}encode(t){return t.uint(13)&&t.uint(this.id)&&t.string(this.name)}});s.set(13,g);const f=t(class{constructor(t,s){this.id=t,this.data=s,this._id=14}encode(t){return t.uint(14)&&t.uint(this.id)&&t.string(this.data)}});s.set(14,f);const p=t(class{constructor(t,s,i){this.id=t,this.x=s,this.y=i,this._id=16}encode(t){return t.uint(16)&&t.uint(this.id)&&t.int(this.x)&&t.int(this.y)}});s.set(16,p);const m=t(class{constructor(t,s){this.id=t,this.label=s,this._id=17}encode(t){return t.uint(17)&&t.uint(this.id)&&t.string(this.label)}});s.set(17,m);const _=t(class{constructor(t,s,i){this.id=t,this.value=s,this.mask=i,this._id=18}encode(t){return t.uint(18)&&t.uint(this.id)&&t.string(this.value)&&t.int(this.mask)}});s.set(18,_);const y=t(class{constructor(t,s){this.id=t,this.checked=s,this._id=19}encode(t){return t.uint(19)&&t.uint(this.id)&&t.boolean(this.checked)}});s.set(19,y);const v=t(class{constructor(t,s){this.x=t,this.y=s,this._id=20}encode(t){return t.uint(20)&&t.uint(this.x)&&t.uint(this.y)}});s.set(20,v);const S=t(class{constructor(t,s){this.level=t,this.value=s,this._id=22}encode(t){return t.uint(22)&&t.string(this.level)&&t.string(this.value)}});s.set(22,S);const b=t(class{constructor(t,s,i,n,e,r,o,h,c){this.requestStart=t,this.responseStart=s,this.responseEnd=i,this.domContentLoadedEventStart=n,this.domContentLoadedEventEnd=e,this.loadEventStart=r,this.loadEventEnd=o,this.firstPaint=h,this.firstContentfulPaint=c,this._id=23}encode(t){return t.uint(23)&&t.uint(this.requestStart)&&t.uint(this.responseStart)&&t.uint(this.responseEnd)&&t.uint(this.domContentLoadedEventStart)&&t.uint(this.domContentLoadedEventEnd)&&t.uint(this.loadEventStart)&&t.uint(this.loadEventEnd)&&t.uint(this.firstPaint)&&t.uint(this.firstContentfulPaint)}});s.set(23,b);const x=t(class{constructor(t,s,i){this.speedIndex=t,this.visuallyComplete=s,this.timeToInteractive=i,this._id=24}encode(t){return t.uint(24)&&t.uint(this.speedIndex)&&t.uint(this.visuallyComplete)&&t.uint(this.timeToInteractive)}});s.set(24,x);const E=t(class{constructor(t,s,i){this.name=t,this.message=s,this.payload=i,this._id=25}encode(t){return t.uint(25)&&t.string(this.name)&&t.string(this.message)&&t.string(this.payload)}});s.set(25,E);const k=t(class{constructor(t,s){this.name=t,this.payload=s,this._id=27}encode(t){return t.uint(27)&&t.string(this.name)&&t.string(this.payload)}});s.set(27,k);const I=t(class{constructor(t){this.id=t,this._id=28}encode(t){return t.uint(28)&&t.string(this.id)}});s.set(28,I);const z=t(class{constructor(t){this.id=t,this._id=29}encode(t){return t.uint(29)&&t.string(this.id)}});s.set(29,z);const w=t(class{constructor(t,s){this.key=t,this.value=s,this._id=30}encode(t){return t.uint(30)&&t.string(this.key)&&t.string(this.value)}});s.set(30,w);const T=t(class{constructor(t,s,i){this.id=t,this.rule=s,this.index=i,this._id=37}encode(t){return t.uint(37)&&t.uint(this.id)&&t.string(this.rule)&&t.uint(this.index)}});s.set(37,T);const L=t(class{constructor(t,s){this.id=t,this.index=s,this._id=38}encode(t){return t.uint(38)&&t.uint(this.id)&&t.uint(this.index)}});s.set(38,L);const A=t(class{constructor(t,s,i,n,e,r,o){this.method=t,this.url=s,this.request=i,this.response=n,this.status=e,this.timestamp=r,this.duration=o,this._id=39}encode(t){return t.uint(39)&&t.string(this.method)&&t.string(this.url)&&t.string(this.request)&&t.string(this.response)&&t.uint(this.status)&&t.uint(this.timestamp)&&t.uint(this.duration)}});s.set(39,A);const C=t(class{constructor(t,s,i,n){this.name=t,this.duration=s,this.args=i,this.result=n,this._id=40}encode(t){return t.uint(40)&&t.string(this.name)&&t.uint(this.duration)&&t.string(this.args)&&t.string(this.result)}});s.set(40,C);const M=t(class{constructor(t,s){this.key=t,this.value=s,this._id=41}encode(t){return t.uint(41)&&t.string(this.key)&&t.string(this.value)}});s.set(41,M);const R=t(class{constructor(t){this.type=t,this._id=42}encode(t){return t.uint(42)&&t.string(this.type)}});s.set(42,R);const N=t(class{constructor(t,s,i){this.action=t,this.state=s,this.duration=i,this._id=44}encode(t){return t.uint(44)&&t.string(this.action)&&t.string(this.state)&&t.uint(this.duration)}});s.set(44,N);const D=t(class{constructor(t,s){this.mutation=t,this.state=s,this._id=45}encode(t){return t.uint(45)&&t.string(this.mutation)&&t.string(this.state)}});s.set(45,D);const U=t(class{constructor(t,s){this.type=t,this.payload=s,this._id=46}encode(t){return t.uint(46)&&t.string(this.type)&&t.string(this.payload)}});s.set(46,U);const O=t(class{constructor(t,s,i){this.action=t,this.state=s,this.duration=i,this._id=47}encode(t){return t.uint(47)&&t.string(this.action)&&t.string(this.state)&&t.uint(this.duration)}});s.set(47,O);const q=t(class{constructor(t,s,i,n){this.operationKind=t,this.operationName=s,this.variables=i,this.response=n,this._id=48}encode(t){return t.uint(48)&&t.string(this.operationKind)&&t.string(this.operationName)&&t.string(this.variables)&&t.string(this.response)}});s.set(48,q);const H=t(class{constructor(t,s,i,n){this.frames=t,this.ticks=s,this.totalJSHeapSize=i,this.usedJSHeapSize=n,this._id=49}encode(t){return t.uint(49)&&t.int(this.frames)&&t.int(this.ticks)&&t.uint(this.totalJSHeapSize)&&t.uint(this.usedJSHeapSize)}});s.set(49,H);const P=t(class{constructor(t,s,i,n,e,r,o,h){this.timestamp=t,this.duration=s,this.ttfb=i,this.headerSize=n,this.encodedBodySize=e,this.decodedBodySize=r,this.url=o,this.initiator=h,this._id=53}encode(t){return t.uint(53)&&t.uint(this.timestamp)&&t.uint(this.duration)&&t.uint(this.ttfb)&&t.uint(this.headerSize)&&t.uint(this.encodedBodySize)&&t.uint(this.decodedBodySize)&&t.string(this.url)&&t.string(this.initiator)}});s.set(53,P);const B=t(class{constructor(t,s){this.downlink=t,this.type=s,this._id=54}encode(t){return t.uint(54)&&t.uint(this.downlink)&&t.string(this.type)}});s.set(54,B);const J=t(class{constructor(t){this.hidden=t,this._id=55}encode(t){return t.uint(55)&&t.boolean(this.hidden)}});s.set(55,J);const j=t(class{constructor(t,s,i,n,e,r,o){this.timestamp=t,this.duration=s,this.context=i,this.containerType=n,this.containerSrc=e,this.containerId=r,this.containerName=o,this._id=59}encode(t){return t.uint(59)&&t.uint(this.timestamp)&&t.uint(this.duration)&&t.uint(this.context)&&t.uint(this.containerType)&&t.string(this.containerSrc)&&t.string(this.containerId)&&t.string(this.containerName)}});s.set(59,j);const G=t(class{constructor(t,s,i,n){this.id=t,this.name=s,this.value=i,this.baseURL=n,this._id=60}encode(t){return t.uint(60)&&t.uint(this.id)&&t.string(this.name)&&t.string(this.value)&&t.string(this.baseURL)}});s.set(60,G);const K=t(class{constructor(t,s,i){this.id=t,this.data=s,this.baseURL=i,this._id=61}encode(t){return t.uint(61)&&t.uint(this.id)&&t.string(this.data)&&t.string(this.baseURL)}});s.set(61,K);const X=t(class{constructor(t,s){this.type=t,this.value=s,this._id=63}encode(t){return t.uint(63)&&t.string(this.type)&&t.string(this.value)}});s.set(63,X);const F=t(class{constructor(t,s){this.name=t,this.payload=s,this._id=64}encode(t){return t.uint(64)&&t.string(this.name)&&t.string(this.payload)}});s.set(64,F);const Q=t(class{constructor(){this._id=65}encode(t){return t.uint(65)}});s.set(65,Q);const V=t(class{constructor(t,s,i,n){this.id=t,this.rule=s,this.index=i,this.baseURL=n,this._id=67}encode(t){return t.uint(67)&&t.uint(this.id)&&t.string(this.rule)&&t.uint(this.index)&&t.string(this.baseURL)}});s.set(67,V);const W=t(class{constructor(t,s,i,n){this.id=t,this.hesitationTime=s,this.label=i,this.selector=n,this._id=69}encode(t){return t.uint(69)&&t.uint(this.id)&&t.uint(this.hesitationTime)&&t.string(this.label)&&t.string(this.selector)}});s.set(69,W);const Y=t(class{constructor(t,s){this.frameID=t,this.id=s,this._id=70}encode(t){return t.uint(70)&&t.uint(this.frameID)&&t.uint(this.id)}});s.set(70,Y);const Z=\"function\"==typeof TextEncoder?new TextEncoder:{encode(t){const s=t.length,i=new Uint8Array(3*s);let n=-1;for(var e=0,r=0,o=0;o!==s;){if(e=t.charCodeAt(o),o+=1,e>=55296&&e<=56319){if(o===s){i[n+=1]=239,i[n+=1]=191,i[n+=1]=189;break}if(!((r=t.charCodeAt(o))>=56320&&r<=57343)){i[n+=1]=239,i[n+=1]=191,i[n+=1]=189;continue}if(o+=1,(e=1024*(e-55296)+r-56320+65536)>65535){i[n+=1]=240|e>>>18,i[n+=1]=128|e>>>12&63,i[n+=1]=128|e>>>6&63,i[n+=1]=128|63&e;continue}}e<=127?i[n+=1]=0|e:e<=2047?(i[n+=1]=192|e>>>6,i[n+=1]=128|63&e):(i[n+=1]=224|e>>>12,i[n+=1]=128|e>>>6&63,i[n+=1]=128|63&e)}return i.subarray(0,n+1)}};class tt{constructor(t){this.size=t,this.offset=0,this.checkpointOffset=0,this.data=new Uint8Array(t)}checkpoint(){this.checkpointOffset=this.offset}isEmpty(){return 0===this.offset}boolean(t){return this.data[this.offset++]=+t,this.offset<=this.size}uint(t){for((t<0||t>Number.MAX_SAFE_INTEGER)&&(t=0);t>=128;)this.data[this.offset++]=t%256|128,t=Math.floor(t/128);return this.data[this.offset++]=t,this.offset<=this.size}int(t){return t=Math.round(t),this.uint(t>=0?2*t:-2*t-1)}string(t){const s=Z.encode(t),i=s.byteLength;return!(!this.uint(i)||this.offset+i>this.size)&&(this.data.set(s,this.offset),this.offset+=i,!0)}reset(){this.offset=0,this.checkpointOffset=0}flush(){const t=this.data.slice(0,this.checkpointOffset);return this.reset(),t}}let st=1e6,it=2e5,nt=new tt(it),et=\"\",rt=\"\",ot=0,ht=0,ct=0,ut=0,at=!0;function dt(){return new i(ot,ut,ht).encode(nt)}let lt=null;const gt=[];let ft,pt=!1,mt=0,_t=8e3,yt=10;function vt(){if(at||\"\"===rt||\"\"===et)return;const t=nt.flush();pt?gt.push(t):(pt=!0,function t(s){const i=new XMLHttpRequest;i.open(\"POST\",et+\"/v1/web/i\",!1),i.setRequestHeader(\"Authorization\",\"Bearer \"+rt),i.onreadystatechange=function(){if(4===this.readyState){if(0==this.status)return;if(this.status>=400)return St(),gt.length=0,401===this.status?void self.postMessage(\"restart\"):void self.postMessage(null);const s=gt.shift();s?t(s):pt=!1}},i.onerror=function(i){if(mt>=yt)return St(),void self.postMessage(null);mt++,setTimeout(()=>t(s),_t)},i.send(s.buffer)}(t)),at=!0,dt()}function St(){et=\"\",rt=\"\",null!==lt&&(clearInterval(lt),lt=null),nt.reset()}self.onmessage=({data:t})=>{if(null!==t)return\"stop\"===t?(vt(),void St()):Array.isArray(t)?void t.forEach(t=>{const i=new(s.get(t._id));if(Object.assign(i,t),i instanceof n?ht=i.timestamp:i instanceof J&&(i.hidden?ft=setTimeout(()=>self.postMessage(\"restart\"),18e5):clearTimeout(ft)),nt.checkpoint(),!i.encode(nt)&&(vt(),!i.encode(nt)))for(;!i.encode(nt);){if(it===st)return console.warn(\"OpenReplay: beacon size overflow.\"),nt.reset(),void dt();it=Math.min(2*it,st),nt=new tt(it),dt()}ut++,at=!1}):(et=t.ingestPoint||et,rt=t.token||rt,ot=t.pageNo||ot,ht=t.startTimestamp||ht,ct=t.timeAdjustment||ct,yt=t.connAttemptCount||yt,_t=t.connAttemptGap||_t,st=t.beaconSizeLimit||st,it=Math.min(st,t.beaconSize||it),nt.isEmpty()&&dt(),void(null===lt&&(lt=setInterval(vt,1e4))));vt()};\n`], { type: 'text/javascript' })));\n            this.worker.onerror = e => {\n                this._debug(\"webworker_error\", e);\n            };\n            let lastTs = timestamp();\n            let fileno = 0;\n            this.worker.onmessage = ({ data }) => {\n                if (data === null) {\n                    this.stop();\n                }\n                else if (data === \"restart\") {\n                    this.stop();\n                    this.start(true);\n                }\n            };\n            const alertWorker = () => {\n                if (this.worker) {\n                    this.worker.postMessage(null);\n                }\n            };\n            // TODO: keep better tactics, discard others (look https://developer.mozilla.org/en-US/docs/Web/API/Navigator/sendBeacon)\n            this.attachEventListener(window, 'beforeunload', alertWorker, false);\n            this.attachEventListener(document, 'mouseleave', alertWorker, false, false);\n            this.attachEventListener(document, 'visibilitychange', alertWorker, false);\n        }\n        catch (e) {\n            this._debug(\"worker_start\", e);\n        }\n    }\n    _debug(context, e) {\n        if (this.options.__debug_report_edp !== null) {\n            fetch(this.options.__debug_report_edp, {\n                method: 'POST',\n                headers: { 'Content-Type': 'application/json' },\n                body: JSON.stringify({\n                    context,\n                    error: `${e}`\n                })\n            });\n        }\n        if (this.options.__debug_log) {\n            warn(\"OpenReplay error: \", context, e);\n        }\n    }\n    send(message, urgent = false) {\n        if (!this.isActive) {\n            return;\n        }\n        this.messages.push(message);\n        if (urgent) {\n            this.commit();\n        }\n    }\n    commit() {\n        if (this.worker && this.messages.length) {\n            this.messages.unshift(new Timestamp(timestamp()));\n            this.worker.postMessage(this.messages);\n            this.commitCallbacks.forEach(cb => cb(this.messages));\n            this.messages.length = 0;\n        }\n    }\n    attachCommitCallback(cb) {\n        this.commitCallbacks.push(cb);\n    }\n    // @Depricated (TODO: remove in 3.5.*)\n    addCommitCallback(cb) {\n        this.attachCommitCallback(cb);\n    }\n    safe(fn) {\n        const app = this;\n        return function (...args) {\n            try {\n                fn.apply(this, args);\n            }\n            catch (e) {\n                app._debug(\"safe_fn_call\", e);\n                // time: timestamp(),\n                // name: e.name,\n                // message: e.message,\n                // stack: e.stack\n            }\n        }; // TODO: correct typing\n    }\n    attachStartCallback(cb) {\n        this.startCallbacks.push(cb);\n    }\n    attachStopCallback(cb) {\n        this.stopCallbacks.push(cb);\n    }\n    attachEventListener(target, type, listener, useSafe = true, useCapture = true) {\n        if (useSafe) {\n            listener = this.safe(listener);\n        }\n        this.attachStartCallback(() => target.addEventListener(type, listener, useCapture));\n        this.attachStopCallback(() => target.removeEventListener(type, listener, useCapture));\n    }\n    getSessionToken() {\n        const token = sessionStorage.getItem(this.options.session_token_key);\n        if (token !== null) {\n            return token;\n        }\n    }\n    getSessionID() {\n        return this._sessionID || undefined;\n    }\n    getHost() {\n        return new URL(this.options.ingestPoint).hostname;\n    }\n    getProjectKey() {\n        return this.projectKey;\n    }\n    getBaseHref() {\n        var _a, _b;\n        if (typeof this.options.resourceBaseHref === 'string') {\n            return this.options.resourceBaseHref;\n        }\n        else if (typeof this.options.resourceBaseHref === 'object') {\n            //switch between  types\n        }\n        if (document.baseURI) {\n            return document.baseURI;\n        }\n        // IE only\n        return ((_b = (_a = document.head) === null || _a === void 0 ? void 0 : _a.getElementsByTagName(\"base\")[0]) === null || _b === void 0 ? void 0 : _b.getAttribute(\"href\")) || location.origin + location.pathname;\n    }\n    resolveResourceURL(resourceURL) {\n        const base = new URL(this.getBaseHref());\n        base.pathname += \"/\" + new URL(resourceURL).pathname;\n        base.pathname.replace(/\\/+/g, \"/\");\n        return base.toString();\n    }\n    isServiceURL(url) {\n        return url.startsWith(this.options.ingestPoint);\n    }\n    active() {\n        return this.isActive;\n    }\n    _start(reset) {\n        if (!this.isActive) {\n            if (!this.worker) {\n                return Promise.reject(\"No worker found: perhaps, CSP is not set.\");\n            }\n            this.isActive = true;\n            let pageNo = 0;\n            const pageNoStr = sessionStorage.getItem(this.options.session_pageno_key);\n            if (pageNoStr != null) {\n                pageNo = parseInt(pageNoStr);\n                pageNo++;\n            }\n            sessionStorage.setItem(this.options.session_pageno_key, pageNo.toString());\n            const startTimestamp = timestamp();\n            const messageData = {\n                ingestPoint: this.options.ingestPoint,\n                pageNo,\n                startTimestamp,\n                connAttemptCount: this.options.connAttemptCount,\n                connAttemptGap: this.options.connAttemptGap,\n            };\n            this.worker.postMessage(messageData); // brings delay of 10th ms?\n            // let token = sessionStorage.getItem(this.options.session_token_key)\n            // const tokenIsActive = localStorage.getItem(\"__or_at_\" + token)\n            // if (tokenIsActive) {\n            //   token = null\n            // }\n            return window.fetch(this.options.ingestPoint + '/v1/web/start', {\n                method: 'POST',\n                headers: {\n                    'Content-Type': 'application/json',\n                },\n                body: JSON.stringify({\n                    token: sessionStorage.getItem(this.options.session_token_key),\n                    userUUID: localStorage.getItem(this.options.local_uuid_key),\n                    projectKey: this.projectKey,\n                    revID: this.revID,\n                    timestamp: startTimestamp,\n                    trackerVersion: this.version,\n                    isSnippet: this.options.__is_snippet,\n                    deviceMemory,\n                    jsHeapSizeLimit,\n                    reset,\n                }),\n            })\n                .then(r => {\n                if (r.status === 200) {\n                    return r.json();\n                }\n                else { // TODO: handle canceling && 403\n                    return r.text().then(text => {\n                        throw new Error(`Server error: ${r.status}. ${text}`);\n                    });\n                }\n            })\n                .then(r => {\n                const { token, userUUID, sessionID, beaconSizeLimit } = r;\n                if (typeof token !== 'string' ||\n                    typeof userUUID !== 'string' ||\n                    (typeof beaconSizeLimit !== 'number' && typeof beaconSizeLimit !== 'undefined')) {\n                    throw new Error(`Incorrect server response: ${JSON.stringify(r)}`);\n                }\n                sessionStorage.setItem(this.options.session_token_key, token);\n                localStorage.setItem(this.options.local_uuid_key, userUUID);\n                // localStorage.setItem(\"__or_at_\" + token, \"true\")\n                // this.attachEventListener(window, 'beforeunload', ()=>{\n                //   localStorage.removeItem(\"__or_at_\" + token)\n                // }, false);\n                // this.attachEventListener(window, 'pagehide', ()=>{\n                //   localStorage.removeItem(\"__or_at_\" + token)\n                // }, false);\n                if (typeof sessionID === 'string') {\n                    this._sessionID = sessionID;\n                }\n                if (!this.worker) {\n                    throw new Error(\"no worker found after start request (this might not happen)\");\n                }\n                this.worker.postMessage({ token, beaconSizeLimit });\n                this.startCallbacks.forEach((cb) => cb());\n                this.observer.observe();\n                this.ticker.start();\n                log(\"OpenReplay tracking started.\");\n                const onStartInfo = { sessionToken: token, userUUID, sessionID };\n                if (typeof this.options.onStart === 'function') {\n                    this.options.onStart(onStartInfo);\n                }\n                return onStartInfo;\n            })\n                .catch(e => {\n                sessionStorage.removeItem(this.options.session_token_key);\n                this.stop();\n                warn(\"OpenReplay was unable to start. \", e);\n                this._debug(\"session_start\", e);\n                throw e;\n            });\n        }\n        return Promise.reject(\"Player is already active\");\n    }\n    start(reset = false) {\n        if (!document.hidden) {\n            return this._start(reset);\n        }\n        else {\n            return new Promise((resolve) => {\n                const onVisibilityChange = () => {\n                    if (!document.hidden) {\n                        document.removeEventListener(\"visibilitychange\", onVisibilityChange);\n                        resolve(this._start(reset));\n                    }\n                };\n                document.addEventListener(\"visibilitychange\", onVisibilityChange);\n            });\n        }\n    }\n    stop() {\n        if (this.isActive) {\n            try {\n                if (this.worker) {\n                    this.worker.postMessage(\"stop\");\n                }\n                this.observer.disconnect();\n                this.nodes.clear();\n                this.ticker.stop();\n                this.stopCallbacks.forEach((cb) => cb());\n                log(\"OpenReplay tracking stopped.\");\n            }\n            finally {\n                this.isActive = false;\n            }\n        }\n    }\n}\n"]},"metadata":{},"sourceType":"module"}